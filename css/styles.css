html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

#map {
    width: 100%;
    height: 100%;

    /* Mobile responsiveness: ensure gestures are handled by Leaflet, not the browser */
    touch-action: none;
    -ms-touch-action: none;
    overscroll-behavior: none;

    /* Encourage GPU compositing (helps on some mobile browsers) */
    transform: translateZ(0);
}

/* --- Popup Styles --- */
.popup-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.popup-title {
    font-weight: bold;
    font-size: 1.2em;
    margin-right: 15px;
}

.popup-icon {
    width: 48px;
    height: 48px;
    object-fit: contain;
}

.popup-desc img {
    max-width: 100%;
    height: auto;
    border-radius: 3px;
    margin-top: 5px;
}

.popup-details-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    table-layout: fixed; /* Forzar ajuste de ancho */
}

.popup-details-table td {
    /*padding: 4px 0;*/
    padding: 8px 0; /* más espacio arriba y abajo */
    /*border-top: 1px solid #eee;*/
    border-top: none; /* quitar todas las líneas */
    vertical-align: top;
    word-wrap: break-word; /* Romper palabras largas */
    overflow-wrap: break-word;
}

.popup-details-table tr:first-child td {
    border-top: none;
}

.popup-details-table td:first-child {
    font-weight: bold;
    padding-right: 10px;
    color: #555;
    width: 40px; /* Ancho fijo reducido para iconos */
    text-align: center;
    vertical-align: top;
}

/* Iconos en lugar de texto para claves */
.popup-key-icon {
    font-size: 1.2em;
    margin-right: 5px;
    display: inline-block;
    width: 20px;
    text-align: center;
}

.popup-nav-link {
    display: inline-block;
    margin-top: 15px;
    font-weight: bold;
    text-decoration: none;
    color: #0078A8;
}

.popup-nav-link:hover {
    text-decoration: underline;
}

/* --- Map Header Container --- */
.map-header-container {
    position: absolute;
    top: 10px;
    left: 0; /* Ocupar todo el ancho */
    width: 100%;
    /* transform: translateX(-50%);  Ya no centramos con transform */
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    /* width: 95%; */
    /* max-width: 800px;  Quitar restricción de ancho máximo para que los botones se expandan */
    pointer-events: none;
}

/* --- Map Header & Legend --- */
.map-header {
    pointer-events: auto;
    background-color: rgba(50, 50, 50, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    text-align: center;
    width: max-content;
    max-width: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: row; /* Alinear horizontalmente siempre */
    align-items: center;
    justify-content: center;
    gap: 15px; /* Espacio entre leyenda y hamburguesa */
    transition: all 0.3s ease;
}

.map-header h1 {
    font-size: 1.1em;
    margin: 0;
}

.map-legend {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    /* width: 100%;  Quitar width 100 para que no fuerce salto */
    flex-wrap: nowrap; /* Intentar no envolver */
}

.legend-item {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    cursor: pointer;
    padding: 8px 10px;
    border-radius: 4px;
    transition: all 0.2s;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid transparent;
    flex-grow: 1;
    min-width: 110px; /* Ancho mínimo para igualar tamaños */
    flex-basis: 0; /* Para que flex-grow funcione equitativamente */
}

.legend-item:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.legend-item.active {
    background-color: rgba(255, 255, 255, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.legend-item.inactive {
    opacity: 0.5;
    filter: grayscale(100%);
}

.legend-item img {
    width: 24px;
    height: 24px;
}

/* --- Contrast Button --- */
.contrast-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    color: white;
}

.contrast-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.contrast-btn.active {
    background-color: rgba(255, 255, 255, 0.9);
    color: #333;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

.contrast-btn svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}

/* --- Fullscreen Button --- */
/* Fullscreen button styles removed as it is now part of zoom controls */

/* --- Side Panel --- */
#info-panel {
    position: fixed;
    top: 0;
    right: -100%; /* Hidden by default */
    width: 100%;
    max-width: 400px;
    height: 100%;
    background-color: white;
    z-index: 2000;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow: -3px 0 15px rgba(0,0,0,0.2);
}

#info-panel.visible {
    right: 0;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
}

.panel-header h2 {
    margin: 0;
    font-size: 1.2em;
    color: #333;
}

#close-panel-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #555;
}

.panel-content {
    padding: 20px;
    overflow-y: auto;
    flex-grow: 1;
}

#map-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
    display: none;
}

/* En pantallas grandes, el overlay no oscurece el mapa, solo bloquea clicks si es necesario */
@media (min-width: 601px) {
    #map-overlay {
        background: transparent;
        pointer-events: none; /* Permitir interacción con el mapa si se desea, o bloquear solo zona panel */
        /* Si queremos bloquear interacción con el mapa pero verlo claro: */
        /* pointer-events: auto; */
    }
}

#map-overlay.visible {
    display: block;
}

/* --- Gesture Overlay (Mobile) --- */
#gesture-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.45);
    z-index: 1500; /* Encima del mapa pero debajo de controles/paneles */
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: none; /* Permitir que los toques pasen al mapa/página */
    display: none; /* Asegurar oculto por defecto */
}

.gesture-msg {
    color: white;
    font-size: 1.4em;
    font-weight: 500;
    text-align: center;
    padding: 0 20px;
}

/* --- Footer Credits --- */
.footer-credits {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1200; /* Encima de todo */
    background: rgba(50, 50, 50, 0.95);
    padding: 5px 15px;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
    font-size: 11px;
    color: #ccc;
    width: auto;
    text-align: center;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 10px;
}

.footer-credits a {
    color: #ccc;
    text-decoration: none;
    font-weight: normal;
    transition: color 0.2s;
}

.footer-credits a:hover {
    color: white;
    text-decoration: underline;
}

.footer-credits .separator {
    color: #666;
}

.footer-credits .powered-by {
    font-style: italic;
    opacity: 0.8;
}

/* --- Custom Zoom Controls --- */
.custom-zoom-controls {
    position: absolute;
    top: 50%;
    left: 20px;
    transform: translateY(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.right-center-controls {
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.zoom-btn {
    width: 40px;
    height: 40px;
    background-color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: #333;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.zoom-btn:hover {
    background-color: #f8f9fa;
    transform: scale(1.05);
    box-shadow: 0 10px 15px rgba(0,0,0,0.1);
}

.zoom-btn:active {
    transform: scale(0.95);
}

.zoom-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .custom-zoom-controls {
        left: 15px;
    }
    
    .right-center-controls {
        right: 15px;
    }

    .zoom-btn {
        width: 36px;
        height: 36px;
    }

    .zoom-btn svg {
        width: 18px;
        height: 18px;
    }
}

/* --- Leaflet Overrides --- */

/* Performance: hint that Leaflet panes/layers will be transformed frequently */
.leaflet-pane,
.leaflet-layer,
.leaflet-tile-container,
.leaflet-zoom-animated {
    will-change: transform;
    backface-visibility: hidden;
}

/* Ocultar el control de zoom por defecto de Leaflet */
.leaflet-control-zoom {
    display: none !important;
}

/* Ocultar atribución por defecto de Leaflet para unificarla en el footer */
.leaflet-control-attribution {
    display: none !important;
}

/* Fix "will-change" warning */
.leaflet-marker-icon, .leaflet-marker-shadow {
    will-change: unset !important;
}

/* Estilo para el marcador seleccionado (halo blanco) */
.marker-selected-halo {
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    border: 2px solid #ffffff;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    pointer-events: none; /* Para que no interfiera con clicks */
    z-index: 900; /* Debajo del marcador pero encima del mapa */
    /* Leaflet ya posiciona el divIcon, no necesitamos position absolute ni transform aquí si usamos iconAnchor correctamente */
    /* Pero para asegurar centrado visual si el icono es irregular: */
    box-sizing: border-box;
}

/* Tooltip personalizado para hover */
.marker-hover-tooltip {
    background: rgba(0, 0, 0, 0.8);
    border: none;
    border-radius: 4px;
    color: white;
    font-weight: bold;
    font-size: 12px;
    padding: 4px 8px;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.marker-hover-tooltip::before {
    border-top-color: rgba(0, 0, 0, 0.8);
}

/* --- High Contrast Mode --- */
body.high-contrast .leaflet-tile-pane {
    filter: contrast(1.2) saturate(1.2);
}

/* Tooltip de municipio */
.municipio-tooltip {
    font-size: 1.25em !important; /* Aumentado 25% (base suele ser 1em o 12px) */
    font-weight: bold;
}

body.high-contrast .leaflet-tooltip {
    font-size: 1.5em !important;
    font-weight: bold !important;
    background-color: #fff !important; /* Fondo blanco sólido */
    color: #000 !important; /* Texto negro forzado */
    border: 2px solid #000 !important; /* Borde negro */
    box-shadow: 0 0 0 2px #fff; /* Doble borde para contraste */
}

body.high-contrast .popup-title,
body.high-contrast .panel-header h2 {
    font-size: 1.5em;
    color: #000; /* Texto negro puro */
}

body.high-contrast .panel-content {
    color: #000;
    background-color: #fff;
}

body.high-contrast .popup-details-table td {
    font-size: 1.2em; /* Un poco más grande */
    color: #000;
    font-weight: 500;
}

/* Botones en alto contraste */
body.high-contrast .menu-item-btn {
    font-size: 0.85em; /* Restaurar tamaño original */
    font-weight: bold;
    background-color: #000; /* Fondo negro */
    color: #fff; /* Texto blanco */
    border: 2px solid #fff; /* Borde blanco fuerte */
    padding: 6px 12px; /* Padding original */
}

/* Ocultar iconos en botones de items en alto contraste */
body.high-contrast .menu-item-btn img {
    display: none;
}

/* Ajustar botones de leyenda en alto contraste */
body.high-contrast .legend-item {
    font-size: 1.1em;
    font-weight: bold;
}

body.high-contrast .legend-item img {
    display: none; /* Ocultar iconos también en leyenda */
}

/* --- Media Queries --- */
@media (max-width: 600px) {
    .map-header-container {
        top: 0; /* Pegado arriba */
        left: 0;
        right: 0;
        width: 100%;
        transform: none;
        max-width: none;
        padding: 0; /* Sin padding externo */
    }

    .map-header {
        width: 100%; /* Full width */
        border-radius: 0; /* Rectángulo a sangre */
        border-bottom-left-radius: 12px; /* Opcional: redondear solo abajo */
        border-bottom-right-radius: 12px;
        flex-direction: row;
        flex-wrap: nowrap; /* No envolver en móvil si es posible */
        padding: 10px 5px; /* Padding interno ajustado */
        background-color: rgba(50, 50, 50, 0.95);
        box-sizing: border-box;
        justify-content: space-evenly; /* Distribuir espacio */
        gap: 5px;
        margin: 0; /* Sin margen */
    }

    /* Separar grupos en el menú de items (Móvil y Escritorio ahora igual) */
    .items-menu {
        position: static;
        width: 100%;
        height: 0;
    }
    
    .items-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        width: 100%;
        /* Asegurar que no se recorten */
        overflow: visible;
        pointer-events: none;
        /* Permitir que ocupen todo el ancho disponible */
        max-width: 100vw;
        padding-left: 10px;
        padding-right: 10px;
    }

    .items-group button {
        pointer-events: auto;
    }

    /* Grupo Productos: Pegado arriba (debajo del header) */
    .items-group.group-productores {
        position: fixed;
        top: 70px;
        left: 0;
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        z-index: 1100;
        transform: translateY(-20px);
        opacity: 0;
        transition: all 0.3s ease;
        visibility: hidden;
        /* Asegurar que no se recorten en escritorio */
        max-height: 40vh; /* Limitar altura si hay muchos */
        overflow-y: visible; /* Permitir que se vean fuera si es necesario, o auto si queremos scroll */
        /* Si usamos auto, necesitamos asegurar que el contenedor padre no limite el ancho */
        /* En la imagen parece que el contenedor map-header-container limita el ancho */
    }
    .items-group.group-productores::-webkit-scrollbar {
        display: none;
    }

    /* Grupo Actividades: Pegado abajo (Footer) */
    .items-group.group-actividades {
        position: fixed;
        bottom: 40px; /* Un poco más arriba para dejar espacio al footer real */
        left: 0;
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        z-index: 1100;
        transform: translateY(20px);
        opacity: 0;
        transition: all 0.3s ease;
        visibility: hidden;
        background: none;
        /* Asegurar que no se recorten en escritorio */
        max-height: 30vh;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        /* Alinear abajo */
        align-items: flex-end; /* Para que crezca hacia arriba visualmente si usamos flex column, pero es row wrap */
        /* En row wrap, align-items es vertical de la línea. */
        /* Queremos que esté pegado abajo. bottom: 40px ya lo hace. */
    }
    .items-group.group-actividades::-webkit-scrollbar {
        display: none;
    }

    /* Mostrar cuando visible */
    .items-menu.visible .items-group {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }
    
    .items-group-title {
        width: 100%;
        text-align: center;
        color: #ccc;
        font-size: 0.8em;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .map-header h1 {
        display: none; /* Ocultar título en móvil para ahorrar espacio si es necesario, o ajustar */
    }

    .map-legend {
        gap: 8px;
        justify-content: space-between; /* Distribuir espacio */
    }

    .legend-item {
        padding: 8px 4px;
        font-size: 0.85em;
        min-width: 100px; /* Un poco menos en móvil pero igualados */
        flex: 1 1 40%; /* Crecer y ocupar espacio, base 40% para que quepan 2 */
    }

}

/* --- Items Menu --- */
.items-menu {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 100%;
    pointer-events: auto;
    max-height: 0; /* Oculto por defecto */
    opacity: 0;
    overflow-y: hidden; /* Ocultar scroll cuando está cerrado */
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.3s ease;
    /* Ocultar scrollbar pero permitir scroll */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE and Edge */
    margin-top: 0; /* Sin margen cuando está cerrado */
}

.items-menu.visible {
    max-height: 40vh; /* Altura máxima al abrir */
    opacity: 1;
    overflow-y: auto; /* Permitir scroll al abrir */
    margin-top: 10px; /* Espacio al abrir */
    padding-bottom: 10px; /* Espacio inferior para scroll */
}

.items-menu::-webkit-scrollbar {
    display: none;
}

.menu-item-btn {
    background-color: rgba(50, 50, 50, 0.8); /* Fondo oscuro semitransparente base */
    color: white;
    border: 2px solid transparent; /* Borde transparente por defecto */
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 5px;
    backdrop-filter: blur(4px);
    
    /* Animación de entrada */
    opacity: 0;
    transform: translateY(-10px);
    animation: slideIn 0.3s forwards;
}

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.menu-item-btn:hover {
    background-color: rgba(50, 50, 50, 0.95);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

/* Estilos específicos por tipo (Bordes de color) */
.menu-item-btn.type-productores {
    border-color: #ffcc00; /* Amarillo para productores */
}

.menu-item-btn.type-actividades {
    border-color: #00ccff; /* Azul para actividades */
}

/* Asociar colores a los botones principales de la leyenda también */
/* Solo mostrar borde de color si el menú está abierto (controlado por clase en body o header) */
/* O simplemente quitamos el borde activo por defecto y lo ponemos solo si .menu-open */

#legend-productores {
    border: 2px solid transparent;
}
/* Solo si el menú está abierto, mostramos la asociación de color */
.menu-open #legend-productores.active {
    border-color: #ffcc00;
}

#legend-actividades {
    border: 2px solid transparent;
}
.menu-open #legend-actividades.active {
    border-color: #00ccff;
}

/* Botón Toggle Menú */
.menu-toggle-btn {
    background: none;
    border: 2px solid transparent;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    transition: all 0.2s;
    margin-left: 0; /* Quitar margen extra */
    position: relative;
    overflow: hidden;
    height: 36px; /* Igualar altura botones leyenda aprox */
    width: 36px;
}

.menu-toggle-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.menu-toggle-btn.active {
    background-color: rgba(255, 255, 255, 0.3);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    border-color: transparent; /* Sin borde animado cuando está activo/abierto */
}

/* Animación de borde cuando NO está activo */
@keyframes borderRotate {
    0% { border-color: #ffcc00; }
    50% { border-color: #00ccff; }
    100% { border-color: #ffcc00; }
}

.menu-toggle-btn:not(.active) {
    /* Borde animado simple pulsante o rotativo de color */
    animation: borderRotate 3s infinite linear;
    /* Opcional: un brillo o box-shadow */
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
}

.menu-toggle-btn svg {
    fill: currentColor;
}

.menu-item-btn img {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

/* (Eliminado estilos antiguos de borde izquierdo) */

@media (max-width: 600px) and (orientation: portrait) {
    /*
    .leaflet-control-zoom {
        display: none;
    }
    */
}
